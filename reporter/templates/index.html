<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Report Maker</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.1.3/dist/css/bootstrap.min.css" rel="stylesheet">
<!-- TinyMCE Cloud script -->
<script src="https://cdn.tiny.cloud/1/rtx7omk2n4bl0ldav2siw1tql21kj8mco8qe6e0xhixj32m0/tinymce/8/tinymce.min.js" referrerpolicy="origin" crossorigin="anonymous"></script>
<script>
  document.addEventListener('DOMContentLoaded', function() {
    tinymce.init({
      apiKey: 'rtx7omk2n4bl0ldav2siw1tql21kj8mco8qe6e0xhixj32m0',
      selector: 'textarea#reportContent',
      plugins: [
        'anchor', 'autolink', 'charmap', 'codesample', 'emoticons', 'link', 'lists',
        'media', 'searchreplace', 'table', 'visualblocks', 'wordcount',
        'checklist', 'mediaembed', 'casechange', 'formatpainter', 'pageembed',
        'a11ychecker', 'tinymcespellchecker', 'permanentpen', 'powerpaste', 'advtable',
        'advcode', 'advtemplate', 'ai', 'uploadcare', 'mentions', 'tinycomments',
        'tableofcontents', 'footnotes', 'mergetags', 'autocorrect', 'typography',
        'inlinecss', 'markdown', 'importword', 'exportword', 'exportpdf'
      ],
      toolbar: 'undo redo | blocks fontfamily fontsize | bold italic underline strikethrough | link media table mergetags | addcomment showcomments | spellcheckdialog a11ycheck typography uploadcare | align lineheight | checklist numlist bullist indent outdent | emoticons charmap | removeformat',
      tinycomments_mode: 'embedded',
      tinycomments_author: 'Author name',
      mergetags_list: [
        { value: 'First.Name', title: 'First Name' },
        { value: 'Email', title: 'Email' }
      ],
      ai_request: (request, respondWith) => respondWith.string(() => Promise.reject('See docs to implement AI Assistant')),
      uploadcare_public_key: 'ce7b1938fe87a435dd9f'
    });
  });
</script>
</head>
<body>
<div class="container-fluid">
    <div class="row">
        <div class="col-md-4 border-end" style="height:100vh; overflow-y:auto;">
            <h4>AI Chat Input</h4>
            <form id="chatForm">
                <div class="mb-3">
                    <label for="message" class="form-label">Message:</label>
                    <textarea class="form-control" id="message" name="message" rows="3"></textarea>
                </div>
                <div class="mb-3">
                    <label for="files" class="form-label">Upload Files:</label>
                    <input class="form-control" type="file" id="files" name="files" multiple>
                </div>
                <div class="mb-3">
                    <label>Template:</label>
                    <select class="form-select" name="template_id">
                        <option value="">--None--</option>
                        {% for t in templates %}
                        <option value="{{ t.id }}">{{ t.name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="mb-3">
                    <label>Text Model:</label>
                    <select class="form-select" name="text_model">
                        {% for m in models.text_models %}
                        <option value="{{ m }}">{{ m }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="mb-3">
                    <label>Embedding Model:</label>
                    <select class="form-select" name="embedding_model">
                        {% for m in models.embed_models %}
                        <option value="{{ m }}">{{ m }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="mb-3">
                    <label>Vision Model:</label>
                    <select class="form-select" name="vision_model">
                        {% for m in models.vision_models %}
                        <option value="{{ m }}">{{ m }}</option>
                        {% endfor %}
                    </select>
                </div>
                <button type="button" class="btn btn-primary" onclick="submitChat()">Send</button>
            </form>
            <div id="chatLog" class="mt-3"></div>
        </div>
        <div class="col-md-8" style="height:100vh; overflow-y:auto;">
            <h4>Report Preview</h4>
            <textarea id="reportContent"></textarea>
            <button class="btn btn-success mt-2" onclick="downloadReport()">Download PDF</button>
        </div>
    </div>
</div>
<script>
let lastReportId = null;
function submitChat() {
    const form = document.getElementById('chatForm');
    const formData = new FormData(form);
    fetch('/chat', { method:'POST', body: formData })
        .then(res => res.json())
        .then(data => {
            // append chat log
            const log = document.getElementById('chatLog');
            log.innerHTML += `<div><b>User:</b> ${formData.get('message')}</div>`;
            log.innerHTML += `<div><b>AI:</b> ${data.reply}</div>`;
            // update report
            tinymce.get('reportContent').setContent(data.report_html);
            // save report ID for download
            lastReportId = data.report_id;
        });
}
function downloadReport() {
    if (!lastReportId) {
        alert('No report available to download.');
        return;
    }
    // open PDF download
    window.open(`/download/${lastReportId}/pdf`);
}
</script>
</body>
</html>
